<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GiLi Point of Sale - Cloud Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4">
        <!-- Header -->
        <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-blue-600">GiLi Point of Sale</h1>
                    <p class="text-gray-600">Cloud PoS - Connected to Railway</p>
                    <div id="backend-info" class="text-sm text-green-600 mt-1">
                        <i class="fas fa-cloud mr-1"></i>
                        <span id="backend-url">Detecting backend...</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <div id="connection-status" class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></div>
                        <span id="connection-text" class="text-sm">Initializing...</span>
                    </div>
                    <button id="sync-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        <i class="fas fa-sync mr-2"></i>Sync
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Products Panel -->
            <div class="lg:col-span-2">
                <div class="bg-white shadow-lg rounded-lg">
                    <div class="p-4 border-b">
                        <h2 class="text-xl font-semibold">Products</h2>
                        <div class="mt-3">
                            <input type="text" id="product-search" placeholder="Search products..." 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                    </div>
                    <div id="products-grid" class="p-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 max-h-96 overflow-y-auto">
                        <div class="text-center py-8 col-span-full">
                            <i class="fas fa-spinner fa-spin text-2xl text-blue-500 mb-2"></i>
                            <p class="text-gray-500">Connecting to Railway backend...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cart Panel -->
            <div class="bg-white shadow-lg rounded-lg">
                <div class="p-4 border-b">
                    <h2 class="text-xl font-semibold">Cart</h2>
                </div>
                <div id="cart-items" class="p-4 space-y-2 max-h-64 overflow-y-auto">
                    <p class="text-gray-500 text-center py-8">Cart is empty</p>
                </div>
                <div class="p-4 border-t bg-gray-50">
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span>Subtotal:</span>
                            <span id="subtotal">‚Çπ0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Tax (18%):</span>
                            <span id="tax">‚Çπ0.00</span>
                        </div>
                        <div class="flex justify-between font-bold text-lg">
                            <span>Total:</span>
                            <span id="total">‚Çπ0.00</span>
                        </div>
                        <button id="checkout-btn" class="w-full bg-green-500 text-white py-2 px-4 rounded mt-3 hover:bg-green-600 disabled:bg-gray-400" disabled>
                            <i class="fas fa-credit-card mr-2"></i>Checkout
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Connection Status -->
        <div class="bg-white shadow-lg rounded-lg p-6 mt-6">
            <h3 class="text-lg font-semibold mb-4">System Status</h3>
            <div id="system-status" class="space-y-2">
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <span>Backend Connection:</span>
                    <span id="backend-status" class="text-yellow-600">Testing...</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <span>Products Loaded:</span>
                    <span id="products-count">0</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <span>Last Sync:</span>
                    <span id="last-sync">Never</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
            <div class="text-center">
                <i class="fas fa-check-circle text-green-500 text-4xl mb-4"></i>
                <h3 class="text-xl font-semibold mb-2">Transaction Successful!</h3>
                <p id="success-message" class="text-gray-600 mb-4"></p>
                <button id="close-modal" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
            <div class="text-center">
                <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                <h3 class="text-xl font-semibold mb-2">Connection Error</h3>
                <p id="error-message" class="text-gray-600 mb-4"></p>
                <button id="close-error-modal" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let cart = [];
        let products = [];
        let isOnline = false;
        let API_BASE = null;
        let lastSyncTime = null;

        // Your Railway backend URLs - EDIT THESE TO MATCH YOUR DEPLOYMENT
        const BACKEND_URLS = [
            'https://your-backend-name.railway.app/api/pos',
            // Add backup URLs here if needed
        ];

        console.log('üöÄ Initializing GiLi Cloud PoS...');

        // Initialize the app
        async function init() {
            updateBackendInfo('Connecting...');
            await findWorkingBackend();
            await loadProducts();
            setupEventListeners();
            
            // Set up periodic sync
            setInterval(() => {
                if (isOnline) {
                    syncData();
                } else {
                    findWorkingBackend();
                }
            }, 30000); // Every 30 seconds
        }

        // Find working backend URL
        async function findWorkingBackend() {
            updateConnectionStatus('syncing', 'Searching backends...');
            
            for (const baseUrl of BACKEND_URLS) {
                try {
                    console.log(`üîç Testing backend: ${baseUrl}`);
                    
                    const response = await fetch(`${baseUrl}/health`, {
                        method: 'GET',
                        mode: 'cors',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.status === 'healthy') {
                            API_BASE = baseUrl;
                            isOnline = true;
                            updateConnectionStatus('online', `Connected (${data.products_available || 0} products)`);
                            updateBackendInfo(baseUrl.replace('/api/pos', ''));
                            updateBackendStatus('Connected');
                            console.log(`‚úÖ Backend connected: ${baseUrl}`);
                            return true;
                        }
                    }
                } catch (error) {
                    console.warn(`‚ùå Backend failed: ${baseUrl} - ${error.message}`);
                }
            }
            
            // No working backend found
            isOnline = false;
            API_BASE = null;
            updateConnectionStatus('offline', 'No backend available');
            updateBackendInfo('Backend not accessible');
            updateBackendStatus('Disconnected');
            showErrorModal('Cannot connect to GiLi backend. Please check your Railway deployment.');
            return false;
        }

        // Update UI elements
        function updateConnectionStatus(status, text) {
            const statusEl = document.getElementById('connection-status');
            const textEl = document.getElementById('connection-text');
            
            statusEl.className = 'w-3 h-3 rounded-full mr-2 ' + 
                (status === 'online' ? 'bg-green-500' : 
                 status === 'syncing' ? 'bg-blue-500 animate-pulse' : 'bg-red-500');
            textEl.textContent = text;
        }

        function updateBackendInfo(info) {
            document.getElementById('backend-url').textContent = info;
        }

        function updateBackendStatus(status) {
            const statusEl = document.getElementById('backend-status');
            statusEl.textContent = status;
            statusEl.className = status === 'Connected' ? 'text-green-600' : 'text-red-600';
        }

        // Load products
        async function loadProducts() {
            if (!isOnline || !API_BASE) {
                displayProducts([]);
                return;
            }

            try {
                console.log('üì¶ Loading products from Railway...');
                
                const response = await fetch(`${API_BASE}/products`, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                products = await response.json();
                displayProducts(products);
                document.getElementById('products-count').textContent = products.length;
                console.log(`‚úÖ Loaded ${products.length} products`);
            } catch (error) {
                console.error('‚ùå Failed to load products:', error);
                displayProducts([]);
                document.getElementById('products-count').textContent = '0';
            }
        }

        // Display products
        function displayProducts(productList) {
            const grid = document.getElementById('products-grid');
            
            if (productList.length === 0) {
                grid.innerHTML = '<p class="text-gray-500 text-center py-8 col-span-full">No products available</p>';
                return;
            }
            
            grid.innerHTML = productList.map(product => `
                <div class="product-card border rounded-lg p-3 hover:shadow-md cursor-pointer transition-all transform hover:scale-105"
                     onclick="addToCart('${product.id}')">
                    <div class="text-center">
                        <i class="fas fa-box text-2xl text-blue-500 mb-2"></i>
                        <h4 class="font-medium text-sm truncate">${product.name}</h4>
                        <p class="text-xs text-gray-500 truncate">${product.sku || product.item_code || 'No SKU'}</p>
                        <p class="text-lg font-bold text-green-600 mt-1">‚Çπ${product.price || product.unit_price}</p>
                        <p class="text-xs text-gray-400">Stock: ${product.stock_quantity || product.stock_qty || 0}</p>
                        <p class="text-xs text-blue-500">${product.category || 'General'}</p>
                    </div>
                </div>
            `).join('');
        }

        // Cart functions
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const existingItem = cart.find(item => item.id === productId);
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    ...product,
                    quantity: 1,
                    price: product.price || product.unit_price
                });
            }
            
            updateCartDisplay();
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            updateCartDisplay();
        }

        function updateCartDisplay() {
            const cartItems = document.getElementById('cart-items');
            const subtotalEl = document.getElementById('subtotal');
            const taxEl = document.getElementById('tax');
            const totalEl = document.getElementById('total');
            const checkoutBtn = document.getElementById('checkout-btn');
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<p class="text-gray-500 text-center py-8">Cart is empty</p>';
                subtotalEl.textContent = '‚Çπ0.00';
                taxEl.textContent = '‚Çπ0.00';
                totalEl.textContent = '‚Çπ0.00';
                checkoutBtn.disabled = true;
                return;
            }
            
            let subtotal = 0;
            
            cartItems.innerHTML = cart.map(item => {
                const lineTotal = item.price * item.quantity;
                subtotal += lineTotal;
                
                return `
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <div class="flex-1">
                            <p class="font-medium text-sm">${item.name}</p>
                            <p class="text-xs text-gray-500">${item.quantity} √ó ‚Çπ${item.price}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="font-bold">‚Çπ${lineTotal.toFixed(2)}</span>
                            <button onclick="removeFromCart('${item.id}')" class="text-red-500 hover:text-red-700">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            const tax = subtotal * 0.18;
            const total = subtotal + tax;
            
            subtotalEl.textContent = `‚Çπ${subtotal.toFixed(2)}`;
            taxEl.textContent = `‚Çπ${tax.toFixed(2)}`;
            totalEl.textContent = `‚Çπ${total.toFixed(2)}`;
            checkoutBtn.disabled = !isOnline;
        }

        // Process checkout
        async function processCheckout() {
            if (cart.length === 0 || !isOnline || !API_BASE) return;
            
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const taxAmount = subtotal * 0.18;
            const total = subtotal + taxAmount;
            
            const transaction = {
                pos_transaction_id: `POS-CLOUD-${Date.now()}`,
                store_location: 'Cloud PoS',
                cashier_id: 'cloud-pos-user',
                customer_id: null,
                items: cart.map(item => ({
                    product_id: item.id,
                    product_name: item.name,
                    quantity: item.quantity,
                    unit_price: item.price,
                    discount_percent: 0,
                    line_total: item.price * item.quantity
                })),
                subtotal: subtotal,
                tax_amount: taxAmount,
                discount_amount: 0,
                total_amount: total,
                payment_method: 'cash',
                payment_details: {},
                status: 'completed',
                transaction_timestamp: new Date().toISOString(),
                pos_device_id: 'cloud-pos-web',
                receipt_number: `R-CLOUD-${Date.now()}`
            };
            
            try {
                updateConnectionStatus('syncing', 'Processing...');
                
                const response = await fetch(`${API_BASE}/transactions`, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(transaction)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    cart = [];
                    updateCartDisplay();
                    showSuccessModal(`Transaction successful!\nSales Order: ${result.sales_order_id}\nSynced to GiLi system.`);
                    updateConnectionStatus('online', 'Transaction completed');
                } else {
                    throw new Error(result.message || 'Transaction failed');
                }
                
            } catch (error) {
                console.error('‚ùå Checkout failed:', error);
                showErrorModal(`Transaction failed: ${error.message}`);
            }
        }

        // Sync data
        async function syncData() {
            if (!isOnline) return;
            
            await loadProducts();
            lastSyncTime = new Date().toLocaleTimeString();
            document.getElementById('last-sync').textContent = lastSyncTime;
        }

        // Modal functions
        function showSuccessModal(message) {
            document.getElementById('success-message').textContent = message;
            document.getElementById('success-modal').classList.remove('hidden');
        }

        function showErrorModal(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-modal').classList.remove('hidden');
        }

        // Event listeners
        function setupEventListeners() {
            // Search
            document.getElementById('product-search').addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                const filtered = products.filter(product => 
                    product.name.toLowerCase().includes(query) ||
                    (product.sku && product.sku.toLowerCase().includes(query)) ||
                    (product.item_code && product.item_code.toLowerCase().includes(query))
                );
                displayProducts(filtered);
            });
            
            // Sync button
            document.getElementById('sync-btn').addEventListener('click', async () => {
                if (!isOnline) {
                    await findWorkingBackend();
                }
                await syncData();
            });
            
            // Checkout
            document.getElementById('checkout-btn').addEventListener('click', processCheckout);
            
            // Modals
            document.getElementById('close-modal').addEventListener('click', () => {
                document.getElementById('success-modal').classList.add('hidden');
            });
            
            document.getElementById('close-error-modal').addEventListener('click', () => {
                document.getElementById('error-modal').classList.add('hidden');
            });
        }

        // Start the app
        init();
    </script>
</body>
</html>