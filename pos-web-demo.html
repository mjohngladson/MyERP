<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GiLi PoS - Web Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4">
        <!-- Header -->
        <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-blue-600">GiLi Point of Sale</h1>
                    <p class="text-gray-600">Web Demo - Integration Test</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <div id="connection-status" class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></div>
                        <span id="connection-text" class="text-sm">Checking...</span>
                    </div>
                    <button id="sync-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        <i class="fas fa-sync mr-2"></i>Sync
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Products Panel -->
            <div class="lg:col-span-2">
                <div class="bg-white shadow-lg rounded-lg">
                    <div class="p-4 border-b">
                        <h2 class="text-xl font-semibold">Products</h2>
                        <div class="mt-3">
                            <input type="text" id="product-search" placeholder="Search products..." 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                    </div>
                    <div id="products-grid" class="p-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 max-h-96 overflow-y-auto">
                        <!-- Products will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Cart Panel -->
            <div class="bg-white shadow-lg rounded-lg">
                <div class="p-4 border-b">
                    <h2 class="text-xl font-semibold">Cart</h2>
                </div>
                <div id="cart-items" class="p-4 space-y-2 max-h-64 overflow-y-auto">
                    <p class="text-gray-500 text-center py-8">Cart is empty</p>
                </div>
                <div class="p-4 border-t bg-gray-50">
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span>Subtotal:</span>
                            <span id="subtotal">â‚¹0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Tax:</span>
                            <span id="tax">â‚¹0.00</span>
                        </div>
                        <div class="flex justify-between font-bold text-lg">
                            <span>Total:</span>
                            <span id="total">â‚¹0.00</span>
                        </div>
                        <button id="checkout-btn" class="w-full bg-green-500 text-white py-2 px-4 rounded mt-3 hover:bg-green-600 disabled:bg-gray-400" disabled>
                            <i class="fas fa-credit-card mr-2"></i>Checkout
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Integration Status -->
        <div class="bg-white shadow-lg rounded-lg p-6 mt-6">
            <h3 class="text-lg font-semibold mb-4">GiLi Backend Integration Status</h3>
            <div id="integration-status" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Status cards will be populated here -->
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
            <div class="text-center">
                <i class="fas fa-check-circle text-green-500 text-4xl mb-4"></i>
                <h3 class="text-xl font-semibold mb-2">Transaction Successful!</h3>
                <p id="success-message" class="text-gray-600 mb-4"></p>
                <button id="close-modal" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let cart = [];
        let products = [];
        let isOnline = false;

        // Backend URL
        const API_BASE = 'http://localhost:8001/api/pos';

        // Initialize the app
        async function init() {
            console.log('ðŸš€ Initializing GiLi PoS Web Demo...');
            
            await checkConnection();
            await loadProducts();
            await loadIntegrationStatus();
            
            setupEventListeners();
            
            console.log('âœ… GiLi PoS Web Demo initialized');
        }

        // Check backend connection
        async function checkConnection() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    isOnline = true;
                    updateConnectionStatus('online', 'Connected to GiLi Backend');
                } else {
                    throw new Error('Backend not healthy');
                }
            } catch (error) {
                isOnline = false;
                updateConnectionStatus('offline', 'Offline Mode');
                console.warn('Backend connection failed:', error);
            }
        }

        // Update connection status display
        function updateConnectionStatus(status, text) {
            const statusEl = document.getElementById('connection-status');
            const textEl = document.getElementById('connection-text');
            
            statusEl.className = 'w-3 h-3 rounded-full mr-2 ' + 
                (status === 'online' ? 'bg-green-500' : 
                 status === 'syncing' ? 'bg-blue-500' : 'bg-red-500');
            textEl.textContent = text;
        }

        // Load products from backend
        async function loadProducts() {
            if (!isOnline) {
                displayProducts([]);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/products`);
                products = await response.json();
                displayProducts(products);
                console.log(`âœ… Loaded ${products.length} products`);
            } catch (error) {
                console.error('Failed to load products:', error);
                displayProducts([]);
            }
        }

        // Display products
        function displayProducts(productList) {
            const grid = document.getElementById('products-grid');
            
            if (productList.length === 0) {
                grid.innerHTML = '<p class="text-gray-500 text-center py-8 col-span-full">No products available</p>';
                return;
            }
            
            grid.innerHTML = productList.map(product => `
                <div class="product-card border rounded-lg p-3 hover:shadow-md cursor-pointer transition-shadow"
                     onclick="addToCart('${product.id}')">
                    <div class="text-center">
                        <i class="fas fa-box text-2xl text-blue-500 mb-2"></i>
                        <h4 class="font-medium text-sm truncate">${product.name}</h4>
                        <p class="text-xs text-gray-500 truncate">${product.sku}</p>
                        <p class="text-lg font-bold text-green-600 mt-1">â‚¹${product.price}</p>
                        <p class="text-xs text-gray-400">Stock: ${product.stock_quantity}</p>
                    </div>
                </div>
            `).join('');
        }

        // Add product to cart
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const existingItem = cart.find(item => item.id === productId);
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    ...product,
                    quantity: 1
                });
            }
            
            updateCartDisplay();
        }

        // Update cart display
        function updateCartDisplay() {
            const cartItems = document.getElementById('cart-items');
            const subtotalEl = document.getElementById('subtotal');
            const taxEl = document.getElementById('tax');
            const totalEl = document.getElementById('total');
            const checkoutBtn = document.getElementById('checkout-btn');
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<p class="text-gray-500 text-center py-8">Cart is empty</p>';
                subtotalEl.textContent = 'â‚¹0.00';
                taxEl.textContent = 'â‚¹0.00';
                totalEl.textContent = 'â‚¹0.00';
                checkoutBtn.disabled = true;
                return;
            }
            
            let subtotal = 0;
            
            cartItems.innerHTML = cart.map(item => {
                const lineTotal = item.price * item.quantity;
                subtotal += lineTotal;
                
                return `
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <div class="flex-1">
                            <p class="font-medium text-sm">${item.name}</p>
                            <p class="text-xs text-gray-500">${item.quantity} Ã— â‚¹${item.price}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="font-bold">â‚¹${lineTotal.toFixed(2)}</span>
                            <button onclick="removeFromCart('${item.id}')" class="text-red-500 hover:text-red-700">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            const tax = subtotal * 0.18; // 18% tax
            const total = subtotal + tax;
            
            subtotalEl.textContent = `â‚¹${subtotal.toFixed(2)}`;
            taxEl.textContent = `â‚¹${tax.toFixed(2)}`;
            totalEl.textContent = `â‚¹${total.toFixed(2)}`;
            checkoutBtn.disabled = false;
        }

        // Remove from cart
        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            updateCartDisplay();
        }

        // Process checkout
        async function processCheckout() {
            if (cart.length === 0 || !isOnline) return;
            
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const taxAmount = subtotal * 0.18;
            const total = subtotal + taxAmount;
            
            const transaction = {
                pos_transaction_id: `POS-${Date.now()}`,
                store_location: 'Web Demo',
                cashier_id: 'web-demo-user',
                customer_id: null,
                items: cart.map(item => ({
                    product_id: item.id,
                    product_name: item.name,
                    quantity: item.quantity,
                    unit_price: item.price,
                    discount_percent: 0,
                    line_total: item.price * item.quantity
                })),
                subtotal: subtotal,
                tax_amount: taxAmount,
                discount_amount: 0,
                total_amount: total,
                payment_method: 'cash',
                payment_details: {},
                status: 'completed',
                transaction_timestamp: new Date().toISOString(),
                pos_device_id: 'web-demo-device',
                receipt_number: `R-${Date.now()}`
            };
            
            try {
                updateConnectionStatus('syncing', 'Processing...');
                
                const response = await fetch(`${API_BASE}/transactions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(transaction)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Clear cart
                    cart = [];
                    updateCartDisplay();
                    
                    // Show success modal
                    showSuccessModal(`Transaction processed successfully! Sales Order ID: ${result.sales_order_id}`);
                    
                    updateConnectionStatus('online', 'Connected to GiLi Backend');
                } else {
                    throw new Error('Transaction failed');
                }
                
            } catch (error) {
                console.error('Checkout failed:', error);
                alert('Transaction failed. Please try again.');
                updateConnectionStatus('online', 'Connected to GiLi Backend');
            }
        }

        // Show success modal
        function showSuccessModal(message) {
            document.getElementById('success-message').textContent = message;
            document.getElementById('success-modal').classList.remove('hidden');
        }

        // Load integration status
        async function loadIntegrationStatus() {
            const statusContainer = document.getElementById('integration-status');
            
            const endpoints = [
                { name: 'Health Check', url: '/health', icon: 'fa-heartbeat' },
                { name: 'Products API', url: '/products', icon: 'fa-box' },
                { name: 'Customers API', url: '/customers', icon: 'fa-users' }
            ];
            
            const statusCards = await Promise.all(endpoints.map(async endpoint => {
                let status = 'error';
                let message = 'Failed';
                
                try {
                    const response = await fetch(`${API_BASE}${endpoint.url}`);
                    if (response.ok) {
                        status = 'success';
                        message = 'Working';
                    }
                } catch (error) {
                    // Keep default error status
                }
                
                const statusColor = status === 'success' ? 'text-green-500' : 'text-red-500';
                const bgColor = status === 'success' ? 'bg-green-50' : 'bg-red-50';
                
                return `
                    <div class="${bgColor} p-4 rounded-lg">
                        <div class="flex items-center">
                            <i class="fas ${endpoint.icon} ${statusColor} text-xl mr-3"></i>
                            <div>
                                <h4 class="font-medium">${endpoint.name}</h4>
                                <p class="text-sm ${statusColor}">${message}</p>
                            </div>
                        </div>
                    </div>
                `;
            }));
            
            statusContainer.innerHTML = statusCards.join('');
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search functionality
            document.getElementById('product-search').addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                const filtered = products.filter(product => 
                    product.name.toLowerCase().includes(query) ||
                    product.sku.toLowerCase().includes(query)
                );
                displayProducts(filtered);
            });
            
            // Sync button
            document.getElementById('sync-btn').addEventListener('click', async () => {
                updateConnectionStatus('syncing', 'Syncing...');
                await checkConnection();
                await loadProducts();
                await loadIntegrationStatus();
            });
            
            // Checkout button
            document.getElementById('checkout-btn').addEventListener('click', processCheckout);
            
            // Close modal
            document.getElementById('close-modal').addEventListener('click', () => {
                document.getElementById('success-modal').classList.add('hidden');
            });
        }

        // Start the app
        init();
    </script>
</body>
</html>